<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <title>SQL Noir - Missioni Locali</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.10.2/sql-wasm.js"></script>
  <style>
    /* === Stile ispirato a SQLNoir === */
    body {
      background-color: #0f0f0f;
      color: #eee;
      font-family: "Fira Code", monospace;
      margin: 0;
      padding: 0;
    }
    h1, h2, h3 { color: #00ff9c; }
    .container { max-width: 1200px; margin: auto; padding: 30px; }
    textarea {
      width: 100%; height: 120px; background: #1b1b1b;
      color: #00ff9c; border: 1px solid #333;
      border-radius: 6px; padding: 10px;
    }
    button {
      background: #00ff9c; color: #0f0f0f;
      border: none; padding: 8px 16px;
      border-radius: 6px; cursor: pointer;
      margin-top: 10px; font-weight: bold;
    }
    button:hover { background: #00cc7a; }
    table {
      border-collapse: collapse; width: 100%; margin-top: 15px;
    }
    th, td {
      border: 1px solid #333; padding: 6px 10px;
    }
    th { background-color: #1e1e1e; color: #00ff9c; }
    tr:nth-child(even) { background-color: #181818; }
    .error { color: #ff6363; }
    .sidebar {
      background: #141414; padding: 20px; border-radius: 8px;
      margin-top: 20px;
    }
    .collapsible {
      background-color: #141414;
      color: #00ff9c;
      cursor: pointer;
      padding: 10px;
      width: 100%;
      text-align: left;
      border: 1px solid #333;
      border-radius: 6px;
      outline: none;
      margin-top: 10px;
    }
    .content {
      padding: 10px;
      display: none;
      background-color: #1b1b1b;
      border-left: 3px solid #00ff9c;
      margin-top: 5px;
    }
    input[type="password"] {
      background: #1b1b1b;
      color: #00ff9c;
      border: 1px solid #333;
      padding: 6px;
      border-radius: 4px;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>SQL Noir - Missioni Locali</h1>

    <div id="login">
      <h3>Inserisci la password del livello</h3>
      <input type="password" id="password" placeholder="Password livello...">
      <button id="enter-btn">Entra</button>
      <p id="login-error" class="error"></p>
    </div>

    <div id="main" style="display:none;">
      <h2 id="level-title"></h2>
      <div id="intro-block" style="display:none;">
      <button type="button" class="collapsible">ðŸ“– Introduzione</button>
      <div class="content" id="intro-text"></div>
      </div>

      <div class="sidebar">
        <h3>Tabelle</h3>
        <ul id="table-list"></ul>
      </div>

      <textarea id="sql-input" placeholder="Scrivi la tua query SQL qui..."></textarea><br>
      <button id="run-btn">Esegui</button>
      <div id="output"></div>
    </div>
  </div>

  <script>
    const levels = {
  "noir1": {
    "title": "Caso #001: La Valigetta scomparsa",
    "db": "./translates/case-001_ita.sqlite",
    "intro": "Ambientato negli anni '80, un'epoca cruda e realistica, una preziosa valigetta Ã¨ scomparsa dal Blue Note Lounge. Un testimone ha riferito che un uomo in trench Ã¨ stato visto fuggire dalla scena. (Data: 19851120)" 
  },
  "noir2": {
    "title": "Caso #002: Il Disco Rubato",
    "db": "./translates/case-002_ita.sqlite",
    "intro": "Nella luce al neon di Los Angeles degli anni '80, il negozio West Hollywood Records Ã¨ stato scosso da un audace furto. Un prezioso disco in vinile, del valore di oltre $10.000, Ã¨ svanito durante una serata movimentata. L'incidente Ã¨ avvenuto il 15 luglio 1983." 
  },
  "noir3": {
    "title": "Caso #003: L'Omicidio al Porto Turistico di Miami",
    "db": "./translates/case-003_ita.sqlite",
    "intro": "Un cadavere Ã¨ stato trovato galleggiare vicino ai moli del Coral Bay Marina nelle prime ore del 14 agosto 1986. Due persone sono state viste nelle vicinanze: una che vive su 'Ocean Drive' (indirizzo 300 circa) e un'altra il cui nome di battesimo finisce con 'ul' e il cognome con 'ez'." 
  },
  "noir4": {
    "title": "Caso #004: L'Omicidio al Ballo in Maschera di Mezzanotte",
    "db": "./translates/case-004_ita.sqlite",
    "intro": "Il 31 ottobre 1987, durante un ballo in maschera in una villa di Coconut Grove, Leonard Pierce Ã¨ stato trovato morto nel giardino. I testimoni hanno menzionato una prenotazione in hotel e attivitÃ  telefonica sospetta." 
  },
  "noir5": {
    "title": "Caso #005: Il Sabotaggio del Silicio",
    "db": "./translates/case-005_ita.sqlite",
    "intro": "QuantumTech, l'azienda tecnologica leader di Miami, stava per presentare il suo rivoluzionario microprocessore 'QuantaX'. Poche ore prima della presentazione, il prototipo Ã¨ stato distrutto e tutti i dati di ricerca sono stati cancellati. Gli investigatori sospettano spionaggio aziendale. (Incidente ID 74, Data: 19890421)" 
  },
  "noir6": {
    "title": "Caso #006: Il Diamante Scomparso",
    "db": "./translates/case-006_ita.sqlite",
    "intro": "Al prestigioso gala di beneficenza dell'Hotel Fontainebleau di Miami, la famosa collana di diamanti 'Cuore di Atlantide' Ã¨ improvvisamente scomparsa dal suo espositore. (Data: 19870520). Molti ospiti sono stati interrogati, ma solo due hanno fornito indizi preziosi: un attore molto famoso e una donna consulente il cui nome di battesimo finisce con 'an'." 
  }
};

    let db;
    
    function hasIntroduzioneParam() {
      const params = new URLSearchParams(window.location.search);
      return params.has("introduzione");
    }
    
    function showLevel(levelKey) {
      const level = levels[levelKey];
      if (!level) return;

      document.getElementById("login").style.display = "none";
      document.getElementById("main").style.display = "block";
      document.getElementById("level-title").innerText = level.title;
      document.getElementById("intro-text").innerHTML = level.intro;

      loadDB(level.db);
    }

    function loadDB(url) {
      fetch(url)
        .then(res => res.arrayBuffer())
        .then(buf => {
          return initSqlJs({
            locateFile: file =>
              `https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.10.2/${file}`
          }).then(SQL => {
            db = new SQL.Database(new Uint8Array(buf));
            refreshTableList();
          });
        })
        .catch(err => {
          document.getElementById("output").innerHTML =
            `<p class="error">Errore caricando DB: ${err.message}</p>`;
        });
    }

    function runQuery() {
      const sql = document.getElementById("sql-input").value;
      const output = document.getElementById("output");
      output.innerHTML = "";
      try {
        const res = db.exec(sql);
        if (res.length === 0) {
          output.innerHTML = "<p>Nessun risultato (query eseguita con successo).</p>";
        } else {
          const table = res[0];
          let html = "<table><tr>";
          table.columns.forEach(c => html += `<th>${c}</th>`);
          html += "</tr>";
          table.values.forEach(row => {
            html += "<tr>";
            row.forEach(v => html += `<td>${v}</td>`);
            html += "</tr>";
          });
          html += "</table>";
          output.innerHTML = html;
        }
        refreshTableList();
      } catch (err) {
        output.innerHTML = `<p class="error">Errore: ${err.message}</p>`;
      }
    }

    function refreshTableList() {
      const ul = document.getElementById("table-list");
      ul.innerHTML = "";
      const res = db.exec("SELECT name FROM sqlite_master WHERE type='table' ORDER BY name;");
      if (res.length > 0) {
        res[0].values.forEach(row => {
          const li = document.createElement("li");
          li.textContent = row[0];
          ul.appendChild(li);
        });
      }
    }

    document.getElementById("run-btn").onclick = runQuery;

    document.getElementById("enter-btn").onclick = () => {
      const pwd = document.getElementById("password").value.trim();
      if (levels[pwd]) showLevel(pwd);
      else document.getElementById("login-error").textContent = "Password errata.";
    };

    // Collapse intro section
    document.addEventListener("click", e => {
      if (e.target.classList.contains("collapsible")) {
        e.target.classList.toggle("active");
        const content = e.target.nextElementSibling;
        content.style.display = content.style.display === "block" ? "none" : "block";
      }
    });
  </script>
</body>
</html>

